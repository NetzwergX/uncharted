<!DOCTYPE html>
<html lang="en">
<head>
  <title>Gliese Catalog of Nearby Stars</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

  <link rel="stylesheet" type="text/css" href="resources/css/bootstrap.min.css" media="screen">
  <link rel="stylesheet" type="text/css" href="css/uncharted.css">

  <script type="text/javascript" src="resources/jquery-2.0.0.min.js"></script>
  <script src="resources/three.min.js"></script>
  <script src="resources/FirstPersonControls.js"></script>
  <script src="resources/Detector.js"></script>

</head>

<body>

<div class="row-fluid row">
  <div class="span10">
    <canvas id='webgl_canvas'></canvas>
  </div>
  <div class="span2">
    <table class="table">
      <tbody>
      <tr>
        <td>
          Name
        </td>
        <td id="name_box">
        </td>
      </tr>
      <tr>
        <td>
          Distance (lys)
        </td>
        <td id="distance_box">
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<script>

  if (!Detector.webgl) Detector.addGetWebGLMessage();

  var camera, scene, renderer;

  var mesh, lightMesh, sphere;
  var stars = [];
  var starsByName = {};

  var projector;

  var directionalLight, pointLight;

  var windowHalfX = window.innerWidth / 2;
  var windowHalfY = window.innerHeight / 2;

  var clock = new THREE.Clock();

  $.ajax({
    type: 'GET',
    dataType: 'html',
    url: "all_gliese",
    success: function (data) {
      var dataParsed = JSON.parse(data);

      init(dataParsed);
      animate();

    }
  });

  var controls;
  var currentStarName = "";
  var currentStarMesh;

  var currentName = $("#name_box");
  var currentDistance = $("#distance_box");

  function init(starData) {

    scene = new THREE.Scene();

    currentStarName = "";

    directionalLight = new THREE.DirectionalLight(0xffffff);
    directionalLight.position.set(1, 1, 2).normalize();
    scene.add(directionalLight);

    sphere = new THREE.SphereGeometry(.1, 16, 16);

    camera = new THREE.PerspectiveCamera(60, (window.innerWidth ) / window.innerHeight, 1, 1000);
    camera.position.z = 0;

    controls = new THREE.FirstPersonControls(camera);
    controls.movementSpeed = 15;
    controls.lookSpeed = 0.1;

    //  the sun
    var mesh = new THREE.Mesh(sphere, new THREE.MeshPhongMaterial({ ambient: 0x000000, color: 0xFFCC00, specular: 0x555555, shininess: 30 }));
    mesh.position.x = 0;
    mesh.position.y = 0;
    mesh.position.z = 0;
    scene.add(mesh);
    stars.push(mesh);

    starData.forEach(function (star) {
      var mesh = new THREE.Mesh(sphere, new THREE.MeshPhongMaterial({ ambient: 0x000000, color: 0x55ff00, specular: 0x555555, shininess: 30 }));

      mesh.position.x = star.cartesianCoordsInLys.x;
      mesh.position.y = star.cartesianCoordsInLys.y;
      mesh.position.z = star.cartesianCoordsInLys.z;

      mesh.scale.x = mesh.scale.y = mesh.scale.z = 1;

      mesh.starData = star;

      scene.add(mesh);
      stars.push(mesh);

      starsByName[star.name] = mesh;
    });

    projector = new THREE.Projector();

    renderer = new THREE.WebGLRenderer({
      canvas: $("#webgl_canvas").get(0)
    });

    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.autoClear = false;

//    $("webgl_canvas").append(renderer.domElement);

    window.addEventListener('resize', onWindowResize, false);

    document.addEventListener('mousemove', onMouseMove, false);

  }

  var onMouseMove = function (event) {
    var vector = new THREE.Vector3(( event.clientX / window.innerWidth ) * 2 - 1, -( event.clientY / window.innerHeight ) * 2 + 1, 0.5);
    projector.unprojectVector(vector, camera);

    var raycaster = new THREE.Raycaster(camera.position, vector.sub(camera.position).normalize());

    var intersects = raycaster.intersectObjects(stars);

    if (intersects.length > 0) {
      var mesh = intersects[0].object;
      var newStar = mesh.starData;
      var newStarName = newStar.name;

      if (newStarName != currentStarName) {

        //  reset old selected star, set new one
        mesh.material.color.setHex( 0xFF0000 );
        if(currentStarMesh != null){
          currentStarMesh.material.color.setHex(0x55ff00);
        }

        buildStarInfo(newStar);

        currentStarMesh = mesh;
        currentStarName = newStarName;
      }
    }
  };

  function buildStarInfo(newStar) {
    //  TODO flesh out

    currentName.text(newStar.name);
    currentDistance.text(newStar.lightYearDistance);

  }

  function onWindowResize() {
    windowHalfX = window.innerWidth / 2;
    windowHalfY = window.innerHeight / 2;
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    controls.handleResize();
    render();
  }


  function animate() {
    requestAnimationFrame(animate);
    render();
  }

  function render() {

    controls.update(clock.getDelta());

    renderer.render(scene, camera);

  }

</script>

</body>
</html>
