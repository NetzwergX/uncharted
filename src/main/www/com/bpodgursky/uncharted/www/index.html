<!DOCTYPE html>
<html lang="en">
<head>
  <title>Solar Neighorhood</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

  <link rel="stylesheet" type="text/css" href="css/jquery-ui.min.css">
  <link rel="stylesheet" type="text/css" href="css/uncharted.css">

  <script type="text/javascript" src="resources/jquery-2.0.0.min.js"></script>
  <script type="text/javascript" src="resources/tinycolor-min.js"></script>
  <script type="text/javascript" src="resources/jquery-ui.min.js"></script>
  <script src="resources/three.min.js"></script>
  <script src="resources/stats.js"></script>
  <script src="js/constants.js"></script>
  <script src="js/FreeLookControls.js"></script>
  <script src="js/OrbitControls.js"></script>
  <script src="js/DynamicMarker.js"></script>
  <script src="js/TweenControls.js"></script>
  <script src="js/TooltipMarker.js"></script>
  <script src="js/System.js"></script>
  <script src="resources/Detector.js"></script>

</head>

<body>

<div>
  <div>
    <div class="overlay-panel" id="info">
      <table>
        <tbody>

        <tr class="header-row">
          <td>
            <b>Names</b>
          </td>
        </tr>

        <tr class="child-row">
          <td>
            Proper Name
          </td>
          <td id="proper_name_box">
          </td>
        </tr>

        <tr class="child-row">
          <td>
            Bayer Flamsteed
          </td>
          <td id="bayer_flamsteed_box">
          </td>
        </tr>

        <tr class="child-row">
          <td>
            Gliese Catalog
          </td>
          <td id="gliese_catalog_box">
          </td>
        </tr>

        <tr class="child-row">
          <td>
            Harvard Revised ID
          </td>
          <td id="harvard_revised_box">
          </td>
        </tr>

        <tr class="child-row">
          <td>
            Hipparcos ID
          </td>
          <td id="hipparcos_box">
          </td>
        </tr>

        <tr class="child-row">
          <td>
            Henry Draper
          </td>
          <td id="henry_draper_box">
          </td>
        </tr>

        <tr>
          <td>&nbsp;</td>
        </tr>

        <tr class="header-row">
          <td>
            <b>Details</b>
          </td>
        </tr>

        <tr class="child-row">
          <td>
            Absolute Magnitude
          </td>
          <td id="abs-magnitude">
          </td>
        </tr>

        <tr class="child-row">
          <td>
            Spectral Type
          </td>
          <td id="spectral-type">
          </td>
        </tr>

        <tr>
          <td>&nbsp;</td>
        </tr>

        <tr class="header-row">
          <td>
            <b>Relative Location</b>
          </td>
        </tr>

        <tr class="child-row">
          <td>
            Distance (lys)
          </td>
          <td id="distance_box">
          </td>
        </tr>

        <tr class="child-row">
          <td>
            Right Ascension (radians)
          </td>
          <td id="right_ascension_box">
          </td>
        </tr>

        <tr class="child-row">
          <td>
            Declination (radians)
          </td>
          <td id="declination_box">
          </td>
        </tr>

        <tr>
          <td>&nbsp;</td>
        </tr>

        <tr class="header-row">
          <td>
            <b>More Information</b>
          </td>
        </tr>

        <tr class="child-row">
          <td>
            <a id="wiki_box" class="external-link" href="" target="_blank">Wikipedia</a>
          </td>
        </tr>


        </tbody>
      </table>
    </div>

    <div class="overlay-panel" id="selector">

      <table>
        <tbody>

        <tr class="header-row">
          <td>
            <b>Control Mode</b>
          </td>
        </tr>

        <tr class="child-row">
          <td>
            <form id="control_mode" name="control_mode" action="#" method="POST">
              <div>
                <label>
                  <input type="radio" name="control_mode" value="orbit" checked>
                </label> Orbit
                <label>
                  <input type="radio" name="control_mode" value="free">
                </label> Free Look
              </div>
            </form>
          </td>
        </tr>

        <tr class="header-row">
          <td>
            <b>Render Radius (lys)</b>
          </td>
        </tr>

        <tr class="child-row">
          <td>
            <form id="render_radius" name="render_radius" action="#" method="POST">
              <div>
                <label>
                  <input type="radio" name="render_radius" value="10">
                </label> 10
                <label>
                  <input type="radio" name="render_radius" value="25">
                </label> 25
                <label>
                  <input type="radio" name="render_radius" value="50" checked>
                </label> 50
                <label>
                  <input type="radio" name="render_radius" value="75" checked>
                </label> 75
              </div>
            </form>
          </td>
        </tr>

        <tr class="header-row">
          <td>
            <b>Jump to</b>
          </td>
        </tr>

        <tr class="child-row">

          <td>
            <div class="ui-widget">
              <label for="jump_to_list">Star: </label>
              <input id="jump_to_list" type="text">
            </div>
          </td>
        </tr>

        </tbody>
      </table>
    </div>

    <div id="attribution-overlay">
      <a href="https://github.com/bpodgursky/uncharted">Source and project info</a><br>
      <a href="http://bpodgursky.com/">Ben Podgursky</a>
    </div>

    <canvas id='webgl_canvas'></canvas>
  </div>
</div>

<script>
  //  TODO use size of star

  if (!Detector.webgl) Detector.addGetWebGLMessage();

  var stats = new Stats();
  stats.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom
  $("#selector").append(stats.dom);

  //  constant stuff

  var SPHERE_GEOMETRY = new THREE.SphereGeometry(1.0, 32, 32);

  //  webgl init


  var canvas = $("#webgl_canvas").get(0);

  var scene = new THREE.Scene();

  var camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.00000000005, 10000);
  camera.position.set(0, 0, -15);
  camera.rotateZ(Math.PI);

  var intersectCamera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, .01, 10000);

  var windowHalfX = window.innerWidth / 2;
  var windowHalfY = window.innerHeight / 2;

  var clock = new THREE.Clock();

  //  kind of cheating since we know the sun is here
  var solMarker = new DynamicMarker(
      new THREE.Vector3(0, 0, 0),
      SOL_MARKER_RADIUS,
      0x0000FF,
      0
  );

  var selector = new DynamicMarker(
      new THREE.Vector3(0, 0, 0),
      MARKER_RADIUS,
      0x00b33c,
      Math.PI / 4
  );

  var lineMaterial = new THREE.LineBasicMaterial({
    color: 0x0000ff,
    depthWrite: false
  });

  var uniforms = {
    time: {type: "f", value: 1.0},
    scale: {type: "f", value: 80}
  };

  var lineSegment;

  var tooltip;
  var tooltipStar;
  var font;

  var mouseX;
  var mouseY;

  var controlMode = '';

  var renderer = new THREE.WebGLRenderer({
    canvas: canvas,
    logarithmicDepthBuffer: true
  });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.autoClear = true;

  var raycaster = new THREE.Raycaster();
  var mouse = new THREE.Vector2();

  var freeLookControls = new THREE.FreeLookControls(camera, canvas);
  var orbitControls = new THREE.OrbitControls(camera, canvas);
  var tweenControls = new THREE.TweenControls(camera);

  scene.add(camera);
  scene.add(intersectCamera);
  scene.add(solMarker.mesh);
  scene.add(selector.mesh);

  //  other data

  var starData;
  var planetData;

  var stars = [];
  var starsByID = {};
  var planetsByStarID = {};
  var visibleStars = [];
  var visibleStarsByName = {};
  var renderRadius = 75;

  var starFragmentShader;
  var starVertexShader;

  var coronaFragmentShader;
  var coronaVertexShader;

  $("#jump_to_list").keydown(function (e) {
    if (e.keyCode == 13) {
      e.preventDefault();
      select(visibleStarsByName[this.value]);
    }
  });

  $("#render_radius").click(function (e) {
    renderRadius = $('input[name=render_radius]:checked', '#render_radius').val();
    updateStarData();
  });

  $('#control_mode').click(function (e) {
    controlMode = $('input[name=control_mode]:checked', '#control_mode').val();
    updateTarget();
  });

  $("#info").click(function (e) {
    e.preventDefault();
  });

  function updateTarget(prevStarMesh) {

    var prevControlMode = controlMode;
    controlMode = 'tween';

    tweenControls.setZoom(currentStarMesh.position, MARKER_RADIUS, 2,
        function () {
          tweenControls.setZoom(currentStarMesh.position,
              MARKER_RADIUS, 1,
              function () {

                if(prevStarMesh) {
                  //  TODO make a amethod for getting radius
                  prevStarMesh.children[0].material.uniforms.scale.value = currentStarMesh.starData.radiusInLys * 3000000;
                }

                if(!prevControlMode || prevControlMode == 'tween'){
                  controlMode = 'orbit';
                }else {
                  controlMode = prevControlMode
                }

                orbitControls.orbit(
                    currentStarMesh.position,
                    starsByID[currentStarPrimaryId].starData.radiusInLys * 2
                )

              }
          )
        });

  }

  var currentStarPrimaryId = "";
  var currentStarMesh;
  var currentSystem;

  //  infobox stuff
  var infoProperName = $("#proper_name_box");
  var infoBayerFlamteed = $("#bayer_flamsteed_box");
  var infoGliese = $("#gliese_catalog_box");
  var infoHarvard = $("#harvard_revised_box");
  var infoHipparcos = $("#hipparcos_box");
  var infoHenryDraper = $("#henry_draper_box");
  var infoSpectralType = $("#spectral-type");
  var infoAbsMagnitude = $("#abs-magnitude");
  var infoDistance = $("#distance_box");
  var infoRightAscension = $("#right_ascension_box");
  var infoDeclination = $("#declination_box");
  var infoWiki = $("#wiki_box");

  infoWiki.click(function (e) {
    window.open(infoWiki.attr('href'), '_blank');
  });

  function getLabelText(identifiers) {

    if (identifiers.properName) {
      return identifiers.properName;
    }

    if (identifiers.glieseId) {
      return identifiers.glieseId;
    }

    if (identifiers.harvardRevisedId) {
      return identifiers.harvardRevisedId;
    }

    if (identifiers.henryDraperId) {
      return identifiers.henryDraperId;
    }

    if (identifiers.hipparcosId) {
      return identifiers.hipparcosId;
    }

  }

  function reassignLabel(targetMesh) {

    if (!targetMesh) {
      return;
    }

    if (!tooltipStar) {
      doReassign(targetMesh);
      return;
    }

    if (tooltipStar.starData.primaryId == targetMesh.starData.primaryId) {
      return;
    }


    doReassign(targetMesh);

  }

  var labelCache = {};

  function doReassign(targetMesh) {

    tooltipStar = targetMesh;

    scene.remove(lineSegment);
    if (tooltip) {
      scene.remove(tooltip.object);
    }

    var targetPos = targetMesh.position;

    var geometry = new THREE.Geometry();
    geometry.vertices.push(currentStarMesh.position);
    geometry.vertices.push(targetPos);
    lineSegment = new THREE.Line(geometry, lineMaterial);

    var lineDistance = currentStarMesh.position.distanceTo(targetPos);
    var label = targetMesh.starData.properName;
    var cacheKey = label + lineDistance;  // could target each star from each other star.

    if (!labelCache[(cacheKey)]) {
      labelCache[cacheKey] = new TooltipMarker(label, lineDistance, targetMesh.starData.radiusInLys);
    }

    tooltip = labelCache[cacheKey];
    tooltip.object.position.set(
        targetPos.x,
        targetPos.y,
        targetPos.z
    );

    scene.add(lineSegment);
    scene.add(tooltip.object);

    tooltip.updateTo(camera);

  }

  function isRender(starData) {

    if (starData.lightYearDistance < renderRadius) {
      return true;
    }
    return false;
  }

  function updateStarData() {

    var renderedStars = {};
    visibleStars.forEach(function (e) {
      renderedStars[e.starData.primaryId] = true;
    });
    visibleStars = [];
    visibleStarsByName = {};

    var nameList = [];

    stars.forEach(function (starMesh) {
      var data = starMesh.starData;
      var starID = data.primaryId;
      var commonName = getLabelText(data.identifiers);
      nameList.push(commonName);
      visibleStarsByName[commonName] = starMesh;

      if (isRender(data)) {
        visibleStars.push(starMesh.children[0]);
        if (!renderedStars[starID]) {
          scene.add(starMesh);
        }
      } else {
        if (renderedStars[starID]) {
          scene.remove(starMesh);
        }
      }
    });

    if (currentStarPrimaryId == "") {
      select(starsByID[15472]);
      reassignLabel(starsByID[70667]);
    }
    //  if we shrunk the render distance
    else if (!renderedStars[currentStarPrimaryId]) {
      select(starsByID[15472]);
    }


    $("#jump_to_list").autocomplete({
      source: nameList
    });

  }

  function getStarForPoint(x, y) {

    if (x && y) {

      mouse.x = ( x / window.innerWidth ) * 2 - 1;
      mouse.y = -( y / window.innerHeight ) * 2 + 1;

      intersectCamera.position.copy(camera.position);
      intersectCamera.rotation.copy(camera.rotation);

      raycaster.setFromCamera(mouse, intersectCamera);

      var intersects = raycaster.intersectObjects(visibleStars, false);

      if (intersects.length > 0) {
        var targetId = intersects[intersects.length - 1].object.starData.primaryId;
        if(targetId != currentStarPrimaryId) {
          return starsByID[targetId];
        }
      }

      if (tooltip) {
        var text = raycaster.intersectObjects(tooltip.scaleObj.children, false);
        if (text.length > 0) {
          return tooltipStar;
        }
      }

    }

    return null;
  }

  function setMouseXY(event) {
    mouseX = event.clientX;
    mouseY = event.clientY;
  }

  function getMouseoverStar() {
    if (!freeLookControls.dragView) {
      var star = getStarForPoint(mouseX, mouseY);

      if (star) {
        canvas.style.cursor = 'pointer';
      } else {
        canvas.style.cursor = 'auto';
      }

      reassignLabel(star);
    }
  }

  function onMouseClick (event) {

    var diffX = Math.abs(mouseDownX - event.clientX);
    var diffY = Math.abs(mouseDownY - event.clientY);
    var delta = Math.sqrt(Math.pow(diffX, 2) + Math.pow(diffY, 2))

    if(delta < 5) {
      select(getStarForPoint(event.clientX, event.clientY));
    }

  }

  function initializeStarData(data) {

    data.forEach(function (star) {

          var material = new THREE.ShaderMaterial({
            uniforms: {
              time: uniforms.time,
              scale: uniforms.scale,
              highTemp: {type: "f", value: star.temperatureEstimate},
              lowTemp: {type: "f", value: star.temperatureEstimate / 4}
            },
            vertexShader: starVertexShader,
            fragmentShader: starFragmentShader,
            transparent: false
          });

          var shaderSurround = new THREE.ShaderMaterial({
            vertexShader: coronaVertexShader,
            fragmentShader: coronaFragmentShader,
            uniforms: {
              scale: {type: "f", value: star.radiusInLys*3000000},
              temp: {type: "f", value: star.temperatureEstimate/2}
            },
            transparent: true
          });

          var mesh = new THREE.Mesh(SPHERE_GEOMETRY, material);

          mesh.position.x = star.cartesianCoordsInLys.x;
          mesh.position.y = star.cartesianCoordsInLys.y;
          mesh.position.z = star.cartesianCoordsInLys.z;

          mesh.scale.x = mesh.scale.y = mesh.scale.z = star.radiusInLys;
          mesh.starData = star;

          var surround = new THREE.Mesh(SPHERE_GEOMETRY, shaderSurround);
          surround.scale.set(3000000, 3000000, 3000000);
          surround.starData = star;

          mesh.add(surround); // this centers the glow at the mesh

          starsByID[star.primaryId] = mesh;
          stars.push(mesh);
          planetsByStarID[star.primaryId] = [];
        }
    );

    planetData.forEach(function(planet){
      var star = planet.starId;
      planetsByStarID[star].push(planet);
    });

  }

  function select(mesh) {

    if (mesh) {

      //  TODO flesh out with more fields
      //     # planets (display them?)

      var newStar = mesh.starData;

      var deltaX = mesh.position.x;
      var deltaY = mesh.position.y;
      var deltaZ = mesh.position.z;

      scene.children.forEach(function (e) {
        e.position.x -= deltaX;
        e.position.y -= deltaY;
        e.position.z -= deltaZ;
      });

      if (newStar != null) {
        var newStarPrimaryId = newStar.primaryId;

        if (newStarPrimaryId != currentStarPrimaryId) {

//          var bf = null;
//          if (newStar.identifiers.bayerFlamsteed) {
//            bf = newStar.identifiers.bayerFlamsteed.prettyName;
//          }
//          setInfoData(bf, infoBayerFlamteed);
//          setInfoData(newStar.identifiers.glieseId, infoGliese);
//          setInfoData(newStar.identifiers.harvardRevisedId, infoHarvard);
//          setInfoData(newStar.identifiers.henryDraperId, infoHenryDraper);
//          setInfoData(newStar.identifiers.hipparcosId, infoHipparcos);
//          setInfoData(newStar.identifiers.properName, infoProperName);
//
//          setInfoData(newStar.rawStellarClassification, infoSpectralType);
//          setInfoData(newStar.absoluteMagnitude.toFixed(2), infoAbsMagnitude);
//
//          setInfoData(newStar.lightYearDistance.toFixed(2), infoDistance);
//          setInfoData(newStar.declinationRadians.toFixed(5), infoDeclination);
//          setInfoData(newStar.rightAscensionRadians.toFixed(5), infoRightAscension);
//
//          setLink(newStar.links.wikipedia, infoWiki);
//
          if(currentSystem) {
            scene.remove(currentSystem.object);
          }

          currentSystem = new System(mesh.position, planetsByStarID[newStar.primaryId]);
          scene.add(currentSystem.object);

          selector.target(mesh.position);


          var prevStarMesh = currentStarMesh;

          currentStarMesh = mesh;
          currentStarPrimaryId = newStarPrimaryId;



          updateTarget(prevStarMesh);

          doReassign(currentStarMesh);

        }
      }


    }


  }

  function setLink(data, element) {
    if (data != null) {
      element.parent().parent().show();
      element.attr('href', data);
    } else {
      element.parent().parent().hide();
    }
  }

  function setInfoData(data, element) {
    if (data != null) {
      element.parent().show();
      element.text(data);
    } else {
      element.parent().hide();
    }
  }

  function onWindowResize() {
    windowHalfX = window.innerWidth / 2;
    windowHalfY = window.innerHeight / 2;
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    render();
  }

  function animate() {
    stats.begin();
    render();
    stats.end();

    requestAnimationFrame(animate);

  }

  function render() {

    var delta = clock.getDelta();
    uniforms.time.value += 0.005 * delta;

    if (controlMode == 'orbit') {
      orbitControls.update(delta);
    } else if (controlMode == 'free') {
      freeLookControls.update(delta);
    } else if (controlMode == 'tween') {
      tweenControls.update(delta);
    }

    getMouseoverStar();

    if (tooltip) {
      tooltip.updateTo(camera);
    }

    selector.updateTo(camera, delta);
    solMarker.updateTo(camera, delta);

    if(currentStarMesh) {

      var distance = camera.position.distanceTo(currentStarMesh.position)*.1;
      var child = currentStarMesh.children[0];
      var childUniform = child.material.uniforms;
      if(childUniform.scale.value != distance) {
        childUniform.scale.value = Math.min(distance, currentStarMesh.starData.radiusInLys*3000000);
      }
    }

    renderer.render(scene, camera);

  }

  canvas.addEventListener('contextmenu', function (event) {
    event.preventDefault();
  }, false);

  canvas.addEventListener('mousemove',
      bind(orbitControls.onMouseMove, freeLookControls.onMouseMove),
      false
  );

  canvas.addEventListener('mousedown',
      bind(orbitControls.onMouseDown, freeLookControls.onMouseDown),
      false
  );

  canvas.addEventListener('mousewheel',
      bind(orbitControls.onMouseWheel, freeLookControls.onMouseWheel),
      false
  );

  canvas.addEventListener('DOMMouseScroll',
      bind(orbitControls.onMouseWheel, freeLookControls.onMouseWheel),
      false
  ); // firefox

  canvas.addEventListener('mouseup',
      bind(orbitControls.onMouseUp, freeLookControls.onMouseUp),
      false
  );

  canvas.addEventListener('keydown',
      bind(orbitControls.onKeyDown, freeLookControls.onKeyDown),
      false
  );

  canvas.addEventListener('keyup',
      bind(orbitControls.onKeyUp, freeLookControls.onKeyUp),
      false
  );

  function bind(orbitFn, freeFn) {
    return function () {
      if (controlMode === 'free') {
        freeFn.apply(freeLookControls, arguments);
      } else if (controlMode === 'orbit') {
        orbitFn.apply(orbitControls, arguments);
      }
    };
  }

  var mouseDownX = 0;
  var mouseDownY = 0;

  function setmouseDown(event) {
    mouseDownX = event.clientX;
    mouseDownY = event.clientY;
  }

  window.addEventListener('resize', onWindowResize, false);
  document.addEventListener('mousemove', setMouseXY, false);
  document.addEventListener('mousedown', setmouseDown, false);
  document.addEventListener('mouseup', onMouseClick, false);

  var loader = new THREE.FontLoader();

  $.when(
      $.ajax({
        type: 'GET',
        dataType: 'html',
        url: "resources/noise/noise-grainy-fragment.glsl",
        success: function (frag) {
          starFragmentShader = frag;
        }
      }),
      $.ajax({
        type: 'GET',
        dataType: 'html',
        url: "resources/noise/vertex-shader.glsl",
        success: function (vert) {
          starVertexShader = vert;
        }
      }),
      $.ajax({
        type: 'GET',
        dataType: 'html',
        url: "resources/noise/corona-vertex-shader.glsl",
        success: function (vert) {
          coronaVertexShader = vert;
        }
      }),
      $.ajax({
        type: 'GET',
        dataType: 'html',
        url: "resources/noise/corona-fragment-shader.glsl",
        success: function (vert) {
          coronaFragmentShader = vert;
        }
      }),
      $.ajax({
        type: 'GET',
        dataType: 'html',
        url: "star_catalog",
        data: {
          "max_lys": 75
        },
        success: function (data) {
          var dataParsed = JSON.parse(data);
          starData = dataParsed.stars;
          planetData = dataParsed.planets;
        }
      })
  ).then(function () {
    loader.load('js/font.js', function (response) {
          font = response;
          initializeStarData(starData);
          animate();
          updateStarData();
        }
    );
  });

</script>

<script>


  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
    a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

  ga('create', 'UA-42483033-4', 'bpodgursky.com');
  ga('send', 'pageview');

</script>

</body>
</html>