<!DOCTYPE html>
<html lang="en">
<head>
  <title>Gliese Catalog of Nearby Stars</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

  <link rel="stylesheet" type="text/css" href="css/uncharted.css">

  <script type="text/javascript" src="resources/jquery-2.0.0.min.js"></script>
  <script src="resources/three.min.js"></script>
  <script src="resources/FirstPersonControls.js"></script>
  <script src="resources/Detector.js"></script>

</head>

<body>

<div>
  <div>
    <canvas id='webgl_canvas'></canvas>
    <div id="info">
      <table>
        <tbody>
        <tr>
          <td>
            Name
          </td>
          <td id="name_box">
          </td>
        </tr>
        <tr>
          <td>
            Distance (lys)
          </td>
          <td id="distance_box">
          </td>
        </tr>
        <tr>
          <td>
            Magnitude
          </td>
          <td id="magnitude">
          </td>
        </tr>
        <tr>
          <td>
            Absolute Magnitude
          </td>
          <td id="abs-magnitude">
          </td>
        </tr>
        <tr>
          <td>
            Class
          </td>
          <td id="class">
          </td>
        </tr>
        <tr>
          <td>
            Other Name
          </td>
          <td id="other-name">
          </td>
        <tr>
          <td>
            Spectral Type
          </td>
          <td id="spectral-type">
          </td>
        </tr>
        <tr>
          <td>
            Remarks
          </td>
          <td id="remarks">
          </td>
        </tr>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>

  if (!Detector.webgl) Detector.addGetWebGLMessage();

  var CLASS_TO_APPARENT_COLOR = {
    O:0x9db4ff,
    B:0xaabfff,
    A:0xcad8ff,
    F:0xfbf8ff,
    G:0xfff4e8,
    K:0xffddb4,
    M:0xffbd6f,
    L:0xf84235,
    T:0xba3059,
    Y:0x605170
  };

  //  TODO size and magnitude of stars

  var camera, scene, renderer, raycaster;

  var mesh, lightMesh, sphere;
  var stars = [];
  var starsByName = {};

  var projector;

  var windowHalfX = window.innerWidth / 2;
  var windowHalfY = window.innerHeight / 2;

  var clock = new THREE.Clock();

  var selector, solMarker;

  $.ajax({
    type: 'GET',
    dataType: 'html',
    url: "all_gliese",
    success: function (data) {
      var dataParsed = JSON.parse(data);

      init(dataParsed);
      animate();

    }
  });

  var controls;
  var currentStarName = "";
  var currentStarMesh;

  var currentName = $("#name_box");
  var currentDistance = $("#distance_box");
  var currentClass = $("#class");
  var currentOtherName = $("#other-name");
  var currentSpectralType = $("#spectral-type");
  var currentAbsMagnitude = $("#abs-magnitude");
  var currentMagnitude = $("#magnitude");
  var currentRemarks = $("remarks");

  function init(starData) {

    scene = new THREE.Scene();

    currentStarName = "";

    var ambientLight = new THREE.AmbientLight(0xcccccc);
    scene.add(ambientLight);

    sphere = new THREE.SphereGeometry(.1, 16, 16);

    camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 10000);
    camera.position.z = 0;

    controls = new THREE.FirstPersonControls(camera);
    controls.movementSpeed = 15;
    controls.lookSpeed = 0.1;

    //  the sun
    var mesh = new THREE.Mesh(sphere, new THREE.MeshPhongMaterial({ ambient: 0xFFA500,
      color: 0xFFCC00,
      specular: 0x555555,
      shininess: 30
    }));

    mesh.position.x = 0;
    mesh.position.y = 0;
    mesh.position.z = 0;
    scene.add(mesh);
    stars.push(mesh);

    //  TODO make the selectors look cooler

    //  for hightlighting stuff
    selector = new THREE.Mesh(new THREE.TetrahedronGeometry(.5), new THREE.MeshBasicMaterial({ color: 0xffffff,
      wireframe: true
    }));

    selector.position.x = 0;
    selector.position.y = 0;
    selector.position.z = 0;

    scene.add(selector);

    //  tetrahedron phone home
    solMarker = new THREE.Mesh(new THREE.TetrahedronGeometry(.5), new THREE.MeshBasicMaterial({ color: 0x0000FF,
      wireframe: true
    }));

    solMarker.position.x = 0;
    solMarker.position.y = 0;
    solMarker.position.z = 0;

    scene.add(solMarker);

    starData.forEach(function (star) {

      //  TODO white dwarfs
      //  TODO use range to scale
      var pureColor = CLASS_TO_APPARENT_COLOR[star.parsedStellarClassification.mainClass];
      console.log(pureColor);
      if(pureColor == null){
        pureColor = CLASS_TO_APPARENT_COLOR["M"];
      }

//      console.log();

      console.log(pureColor);

//      //  TODO requires no explanation why this is hacky...
//      var fractionStrength = (20-star.absoluteVisualMagnitude)/21;
//      console.log(fractionStrength);
//
//      var adjColor = shadeColor(pureColor, fractionStrength*100);
//      console.log(adjColor);

      var mesh = new THREE.Mesh(sphere, new THREE.MeshPhongMaterial({ ambient: pureColor,
        color: pureColor,
        specular: pureColor,
        shininess: 30
      }));

      mesh.position.x = star.cartesianCoordsInLys.x;
      mesh.position.y = star.cartesianCoordsInLys.y;
      mesh.position.z = star.cartesianCoordsInLys.z;

      mesh.scale.x = mesh.scale.y = mesh.scale.z = 1;

      mesh.starData = star;

      scene.add(mesh);
      stars.push(mesh);

      starsByName[star.name] = mesh;
    });

    projector = new THREE.Projector();

    renderer = new THREE.WebGLRenderer({
      canvas: $("#webgl_canvas").get(0)
    });

    raycaster = new THREE.Raycaster();

    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.autoClear = false;

    window.addEventListener('resize', onWindowResize, false);

    document.addEventListener('mousemove', onMouseMove, false);

  }

  function shadeColor(color, percent) {
    var num = parseInt(color,16),
        amt = Math.round(2.55 * percent),
        R = (num >> 16) + amt,
        B = (num >> 8 & 0x00FF) + amt,
        G = (num & 0x0000FF) + amt;
    return (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (B<255?B<1?0:B:255)*0x100 + (G<255?G<1?0:G:255)).toString(16).slice(1);
  }

  var onMouseMove = function (event) {
    var vector = new THREE.Vector3(( event.clientX / window.innerWidth ) * 2 - 1, -( event.clientY / window.innerHeight ) * 2 + 1, 1.0);
    projector.unprojectVector(vector, camera);

    raycaster.set(camera.position, vector.sub(camera.position).normalize());

    var intersects = raycaster.intersectObjects(stars);

    if (intersects.length > 0) {
      var mesh = intersects[0].object;
      var newStar = mesh.starData;
      if(newStar != null){
        var newStarName = newStar.name;

        if (newStarName != currentStarName) {

          buildStarInfo(newStar);

          selector.position = mesh.position;

          currentStarMesh = mesh;
          currentStarName = newStarName;
        }
      }
    }
  };

  function buildStarInfo(newStar) {

    //  TODO flesh out with more fields
    //     links to wiki
    //     find more common names (alpha centari, etc)
    //     # planets (display them?)
    currentName.text(newStar.name);
    currentDistance.text(newStar.lightYearDistance.toFixed(2));
    currentOtherName.text(newStar.otherName);
    currentSpectralType.text(newStar.spectralType);
    currentAbsMagnitude.text(newStar.absoluteVisualMagnitude);
    currentMagnitude.text(newStar.apparentMagnitude);
    currentRemarks.text(newStar.remarks);
    currentClass.text(newStar.starClass);

  }

  function onWindowResize() {
    windowHalfX = window.innerWidth / 2;
    windowHalfY = window.innerHeight / 2;
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    controls.handleResize();
    render();
  }

  function animate() {
    requestAnimationFrame(animate);
    render();
  }

  function render() {

    selector.rotation.x = selector.rotation.x + .005;
    solMarker.rotation.x = solMarker.rotation.x + .005;

    controls.update(clock.getDelta());
    renderer.render(scene, camera);
  }

</script>

</body>
</html>
